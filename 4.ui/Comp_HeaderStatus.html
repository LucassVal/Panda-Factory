<!-- ============================================= -->
<!-- HEADER STATUS v4.1 (pf- prefix standard)    -->
<!-- Health Score + Arc Energy + Status Pills    -->
<!-- ============================================= -->
<style>
  /* Header Base */
  .pf-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 2000;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid rgba(102, 126, 234, 0.1);
  }

  .dark-mode .pf-header {
    background: rgba(15, 15, 20, 0.9);
    border-bottom-color: rgba(102, 126, 234, 0.15);
  }

  /* Brand */
  .pf-header-brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .pf-header-brand h1 {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary, #1a1a2e);
  }

  .dark-mode .pf-header-brand h1 {
    color: #fff;
  }

  .pf-header-brand .pf-logo-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
  }

  .pf-version-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(102, 126, 234, 0.15);
    color: #667eea;
    font-weight: 600;
  }

  /* Status Monitor Bar */
  .pf-status-bar {
    display: flex;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(102, 126, 234, 0.06);
    border-radius: 20px;
  }

  .pf-status-pill {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .pf-status-pill:hover {
    background: rgba(102, 126, 234, 0.1);
  }

  .pf-status-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-secondary, #64748b);
    text-transform: uppercase;
  }

  .pf-status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .pf-status-dot.online {
    background: #10b981;
    box-shadow: 0 0 6px #10b981;
  }
  .pf-status-dot.warning {
    background: #f59e0b;
    box-shadow: 0 0 6px #f59e0b;
  }
  .pf-status-dot.offline {
    background: #ef4444;
    box-shadow: 0 0 6px #ef4444;
  }

  /* Arc Energy Bar */
  .pf-arc-energy {
    position: relative;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .pf-arc-energy svg {
    position: absolute;
    transform: rotate(-90deg);
  }

  .pf-arc-energy-bg {
    fill: none;
    stroke: rgba(102, 126, 234, 0.15);
    stroke-width: 3;
  }

  .pf-arc-energy-fill {
    fill: none;
    stroke: url(#energyGradient);
    stroke-width: 3;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease;
  }

  .pf-arc-energy-text {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-primary, #1a1a2e);
  }

  .dark-mode .pf-arc-energy-text {
    color: #fff;
  }

  /* Treasury Widget */
  .pf-treasury-widget {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: rgba(16, 185, 129, 0.1);
  }

  .pf-treasury-widget:hover {
    background: rgba(16, 185, 129, 0.2);
  }

  .pf-treasury-icon {
    font-size: 16px;
  }

  .pf-treasury-score {
    font-size: 13px;
    font-weight: 700;
    color: #10b981;
  }

  /* Header Controls */
  .pf-header-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .pf-header-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: none;
    background: rgba(102, 126, 234, 0.08);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s ease;
  }

  .pf-header-btn:hover {
    background: rgba(102, 126, 234, 0.15);
    transform: scale(1.05);
  }

  .pf-header-user {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 12px;
    border-radius: 20px;
    background: rgba(102, 126, 234, 0.06);
  }

  .pf-header-user-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary, #1a1a2e);
  }

  .dark-mode .pf-header-user-name {
    color: #fff;
  }

  .pf-header-time {
    font-size: 12px;
    color: var(--text-secondary, #64748b);
    font-family: monospace;
  }

  .pf-header-logout {
    padding: 6px 12px;
    border-radius: 8px;
    border: none;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .pf-header-logout:hover {
    background: rgba(239, 68, 68, 0.2);
  }
</style>

<div class="pf-header">
  <!-- LEFT: Brand -->
  <div class="pf-header-brand">
    <h1>
      <img
        src="assets/panda_logo.jpg"
        alt="üêº"
        class="pf-logo-icon"
        onerror="this.outerHTML = 'üêº'"
      />
      <span>Panda Fabrics</span>
    </h1>
    <span class="pf-version-badge">v5.0</span>
  </div>

  <!-- CENTER: Status Pills -->
  <div class="pf-status-bar">
    <div
      class="pf-status-pill"
      title="Firebase Realtime"
      onclick="PandaStatus.showDetails('firebase')"
    >
      <span class="pf-status-label">FB</span>
      <div class="pf-status-dot" id="statusFirebase"></div>
    </div>
    <div
      class="pf-status-pill"
      title="Google Apps Script"
      onclick="PandaStatus.showDetails('gas')"
    >
      <span class="pf-status-label">GA</span>
      <div class="pf-status-dot" id="statusGAS"></div>
    </div>
    <div
      class="pf-status-pill"
      title="Rust Agent"
      onclick="PandaStatus.showDetails('rust')"
    >
      <span class="pf-status-label">RU</span>
      <div class="pf-status-dot" id="statusRust"></div>
    </div>
    <div
      class="pf-status-pill"
      title="AI (Gemini)"
      onclick="PandaStatus.showDetails('ai')"
    >
      <span class="pf-status-label">AI</span>
      <div class="pf-status-dot" id="statusAI"></div>
    </div>
    <div
      class="pf-status-pill"
      title="Local GPU"
      onclick="PandaStatus.showDetails('gpu')"
    >
      <span class="pf-status-label">GP</span>
      <div class="pf-status-dot" id="statusGPU"></div>
    </div>
  </div>

  <!-- RIGHT: Controls -->
  <div class="pf-header-controls">
    <!-- Arc Energy Bar -->
    <div
      class="pf-arc-energy"
      title="Panda Coins Balance"
      onclick="PandaSettings.showSection('wallet')"
    >
      <svg width="48" height="48" viewBox="0 0 48 48">
        <defs>
          <linearGradient id="energyGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color: #10b981" />
            <stop offset="50%" style="stop-color: #f59e0b" />
            <stop offset="100%" style="stop-color: #ef4444" />
          </linearGradient>
        </defs>
        <circle class="pf-arc-energy-bg" cx="24" cy="24" r="20" />
        <circle
          class="pf-arc-energy-fill"
          id="energyArc"
          cx="24"
          cy="24"
          r="20"
          stroke-dasharray="125.6"
          stroke-dashoffset="12.56"
        />
      </svg>
      <span class="pf-arc-energy-text" id="energyPercent">90%</span>
    </div>

    <!-- Treasury Health Score -->
    <div
      class="pf-treasury-widget"
      onclick="PandaTreasury.open()"
      title="Treasury Health Score"
    >
      <span class="pf-treasury-icon">üè¶</span>
      <span class="pf-treasury-score" id="healthScore">92%</span>
    </div>

    <!-- Settings -->
    <button
      class="pf-header-btn"
      onclick="PandaSettings.open()"
      title="Settings"
    >
      ‚öôÔ∏è
    </button>

    <!-- User Info -->
    <div class="pf-header-user">
      <span class="pf-header-user-name" id="headerUserName">üë§ Admin</span>
      <span class="pf-header-time" id="headerClock">15:51</span>
    </div>

    <!-- Logout -->
    <button class="pf-header-logout" onclick="fazerLogout()" title="Sair">
      üö™ Sair
    </button>
  </div>
</div>

<script>
  /**
   * PandaStatus Controller v4.1
   */
  window.PandaStatus = {
    statuses: {
      firebase: "online",
      gas: "warning",
      rust: "online",
      ai: "online",
      gpu: "offline",
    },

    init() {
      this.updateAll();
      this.startClock();
      // Poll status every 30s
      setInterval(() => this.checkStatus(), 30000);
    },

    updateAll() {
      Object.entries(this.statuses).forEach(([key, status]) => {
        const el = document.getElementById(
          "status" + key.charAt(0).toUpperCase() + key.slice(1),
        );
        if (el) {
          el.className = "pf-status-dot " + status;
        }
      });
    },

    async checkStatus() {
      // Check Firebase
      if (typeof firebase !== "undefined") {
        this.statuses.firebase = "online";
      }

      // Check Rust Agent
      if (typeof Panda !== "undefined" && Panda.Bridge) {
        try {
          await Panda.Bridge.ping();
          this.statuses.rust = "online";
        } catch {
          this.statuses.rust = "offline";
        }
      }

      // Check GPU
      if (typeof Panda !== "undefined" && Panda.GPU) {
        this.statuses.gpu = Panda.GPU.isAvailable() ? "online" : "offline";
      }

      this.updateAll();
    },

    showDetails(service) {
      const messages = {
        firebase: "Firebase Realtime: Sincroniza√ß√£o de comandos",
        gas: "Google Apps Script: Backend serverless",
        rust: "Rust Agent: Processamento local",
        ai: "AI (Gemini): Assistente inteligente",
        gpu: "GPU Local: Acelera√ß√£o de hardware",
      };
      Panda?.UI?.toast?.(messages[service], "info");
    },

    startClock() {
      const updateClock = () => {
        const now = new Date();
        const time = now.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        });
        const el = document.getElementById("headerClock");
        if (el) el.textContent = time;
      };
      updateClock();
      setInterval(updateClock, 1000);
    },
  };

  /**
   * Arc Energy Controller
   */
  window.updateEnergy = function (percent) {
    const arc = document.getElementById("energyArc");
    const text = document.getElementById("energyPercent");
    if (arc && text) {
      const circumference = 125.6; // 2 * PI * 20
      const offset = circumference - (percent / 100) * circumference;
      arc.style.strokeDashoffset = offset;
      text.textContent = percent + "%";
    }
  };

  /**
   * Conecta Header com o SDK
   */
  async function syncWithSDK() {
    if (typeof Panda === "undefined") return;

    // 1. Atualiza Arc Energy com saldo da wallet
    try {
      const balance = await Panda.Wallet.getBalance();
      // Mapeia saldo para percentual (0-1000 PC = 0-100%)
      const percent = Math.min(100, Math.round((balance.coins / 1000) * 100));
      updateEnergy(percent);
    } catch (e) {
      console.warn("Wallet fetch failed:", e);
    }

    // 2. Atualiza status do Rust Agent
    if (Panda.Bridge) {
      const connected = Panda.Bridge.isConnected();
      const rustDot = document.getElementById("statusRust");
      if (rustDot) {
        rustDot.classList.toggle("online", connected);
        rustDot.classList.toggle("offline", !connected);
      }
      const gpuDot = document.getElementById("statusGPU");
      if (gpuDot) {
        gpuDot.classList.toggle("online", connected);
        gpuDot.classList.toggle("offline", !connected);
      }
    }

    // 3. Atualiza username
    const user = Panda.Auth.getUser();
    if (user) {
      const nameEl = document.getElementById("headerUserName");
      if (nameEl) nameEl.textContent = `üë§ ${user.name}`;
    }

    // 4. Health Score (mock ou de localStorage)
    const healthScore = localStorage.getItem("pandaHealthScore") || "92";
    const healthEl = document.getElementById("healthScore");
    if (healthEl) healthEl.textContent = healthScore + "%";
  }

  // Init on load
  document.addEventListener("DOMContentLoaded", () => {
    PandaStatus.init();
    updateEnergy(90);

    // Sync com SDK ap√≥s pequeno delay (para SDK carregar)
    setTimeout(syncWithSDK, 500);
  });

  // Escuta mudan√ßas de wallet
  if (typeof Panda !== "undefined") {
    Panda.on("wallet:change", ({ balance }) => {
      const percent = Math.min(100, Math.round((balance / 1000) * 100));
      updateEnergy(percent);
    });

    Panda.on("agent:status", ({ connected }) => {
      const rustDot = document.getElementById("statusRust");
      const gpuDot = document.getElementById("statusGPU");
      if (rustDot) rustDot.classList.toggle("online", connected);
      if (gpuDot) gpuDot.classList.toggle("online", connected);
    });
  }

  console.log("üêº Header v4.1 loaded (pf- prefix standard)");
</script>
